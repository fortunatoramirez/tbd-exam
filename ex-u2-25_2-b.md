# Examen Práctico: Gestión de Componentes y Sensores Biomédicos

*Node.js + Express + MySQL*

> **Indicaciones**
>
> * Usa **`res.send(...)`** para respuestas HTML.
> * Entrega **capturas** de cada ejercicio.
> * No uses ORM ni plantillas; solo **Express, `mysql2`, `body-parser`, HTML/CSS**.

---

## Ejercicio 1: Configuración Inicial del Proyecto

1. **Estructura:**

* `gestion-componentes/`

  * `server.js`
  * `public/`

    * `index.html`
    * `styles.css` (se crea en el Ej. 2)

2. **Instala dependencias:**

```bash
npm init -y
npm install express mysql2 body-parser
```

3. **Servidor básico (`server.js`):**

```javascript
const express = require('express');
const bodyParser = require('body-parser');
const mysql = require('mysql2');

const app = express();
const PORT = 3000;

app.use(bodyParser.urlencoded({ extended: true }));
app.use(express.static('public'));

// (Conexión MySQL en Ej. 3)

app.listen(PORT, () => {
  console.log(`Servidor corriendo en http://localhost:${PORT}`);
});
```

4. **Evidencia:** captura de la terminal con el mensaje anterior.

---

## Ejercicio 2: Formulario HTML para Registrar Componentes/Sensores

1. **`public/index.html`**

```html
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Componentes y Sensores Biomédicos</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>Registrar Componente/Sensor Biomédico</h1>

  <form action="/add-componente" method="POST" class="card">
    <label for="nombre">Nombre del componente/sensor:</label>
    <input type="text" id="nombre" name="nombre" required>

    <label for="cantidad">Cantidad:</label>
    <input type="number" id="cantidad" name="cantidad" min="0" required>

    <label for="proveedor">Proveedor:</label>
    <input type="text" id="proveedor" name="proveedor" required>

    <label for="fecha">Fecha de adquisición:</label>
    <input type="date" id="fecha" name="fecha" required>

    <button type="submit" class="btn-submit">Registrar</button>
  </form>

  <div class="actions">
    <a class="btn" href="/componentes">Ver componentes/sensores</a>
    <a class="btn" href="/componentes?orden=desc">Ver por fecha (recientes primero)</a>
  </div>

  <form action="/buscar" method="GET" class="card">
    <h2>Buscar</h2>
    <input type="text" name="q" placeholder="Nombre o proveedor" required>
    <button type="submit" class="btn-submit">Buscar</button>
  </form>
</body>
</html>
```

2. **`public/styles.css`**

```css
:root{--bg:#f4f4f9;--fg:#333;--accent:#007bff;--accent-hover:#0067d4;--card-bg:#fff;--border:#ddd;--ok:#16a34a;--err:#dc2626}
*{box-sizing:border-box}
body{font-family:Arial,sans-serif;background:var(--bg);margin:0;padding:24px;color:var(--fg);text-align:center}
h1{margin-bottom:20px}
.card{max-width:480px;margin:16px auto;padding:20px;background:var(--card-bg);border:1px solid var(--border);border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,.06);text-align:left}
label{display:block;font-weight:bold;margin:12px 0 6px}
input{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px}
.btn,.btn-submit{display:inline-block;width:100%;padding:12px;margin-top:14px;background:var(--accent);color:#fff;font-weight:bold;border:none;border-radius:6px;cursor:pointer;text-decoration:none;text-align:center}
.btn:hover,.btn-submit:hover{background:var(--accent-hover)}
.actions{max-width:480px;margin:0 auto 12px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
.table-wrap{max-width:1000px;margin:24px auto;overflow-x:auto}
table{width:100%;border-collapse:collapse;background:var(--card-bg);border:1px solid var(--border);border-radius:10px;overflow:hidden}
thead th{background:#f2f2f2;padding:12px;border-bottom:1px solid var(--border)}
tbody td{padding:12px;border-bottom:1px solid var(--border)}
tbody tr:hover{background:#fafafa}
.msg{max-width:480px;margin:16px auto;padding:12px 16px;border-radius:8px;font-weight:bold}
.msg.ok{background:#dcfce7;color:var(--ok);border:1px solid #86efac}
.msg.err{background:#fee2e2;color:var(--err);border:1px solid #fecaca}
```

3. **Evidencia:** captura de la página en `http://localhost:3000`.

---

## Ejercicio 3: Inserción de Datos en MySQL

1. **Crear BD y tabla**

```sql
CREATE DATABASE IF NOT EXISTS gestion_componentes
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_unicode_ci;
USE gestion_componentes;

CREATE TABLE IF NOT EXISTS componentes (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nombre VARCHAR(120) NOT NULL,
  cantidad INT UNSIGNED NOT NULL,
  proveedor VARCHAR(120) NOT NULL,
  fecha_adquisicion DATE NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;
```

2. **Conexión en `server.js`** (bajo los `app.use(...)`)

```javascript
const db = mysql.createConnection({
  host: 'localhost',
  user: 'tu_usuario',         // ← reemplaza
  password: 'tu_contraseña',  // ← reemplaza
  database: 'gestion_componentes'
});

db.connect((err) => {
  if (err) {
    console.error('Error conectando a la base de datos:', err);
    process.exit(1);
  }
  console.log('Conectado a la base de datos MySQL');
});
```

3. **Ruta POST `/add-componente`**

```javascript
app.post('/add-componente', (req, res) => {
  const { nombre, cantidad, proveedor, fecha } = req.body;
  const sql = `
    INSERT INTO componentes (nombre, cantidad, proveedor, fecha_adquisicion)
    VALUES (?, ?, ?, ?)
  `;
  db.query(sql, [nombre, cantidad, proveedor, fecha], (err) => {
    if (err) {
      console.error('Error insertando datos:', err);
      return res.status(500).send(`
        <!DOCTYPE html><html lang="es"><head>
        <meta charset="UTF-8"><link rel="stylesheet" href="/styles.css"><title>Error</title>
        </head><body>
          <div class="msg err">Error al registrar el componente/sensor.</div>
          <a class="btn" href="/">Volver</a>
        </body></html>
      `);
    }
    res.send(`
      <!DOCTYPE html><html lang="es"><head>
      <meta charset="UTF-8"><link rel="stylesheet" href="/styles.css"><title>Éxito</title>
      </head><body>
        <div class="msg ok">Componente/Sensor registrado con éxito.</div>
        <div class="actions">
          <a class="btn" href="/">Registrar otro</a>
          <a class="btn" href="/componentes">Ver componentes/sensores</a>
        </div>
      </body></html>
    `);
  });
});
```

4. **Evidencias:**

* Inserta **al menos 5** componentes/sensores desde el formulario.
* Muestra en MySQL: `SELECT * FROM gestion_componentes.componentes;`

---

## Ejercicio 4: Consulta y Muestra de Componentes/Sensores

**Ruta GET `/componentes`** (con orden opcional por fecha)

```javascript
function renderTabla(title, rows) {
  let body = rows.map(r => `
    <tr>
      <td>${r.nombre}</td>
      <td>${r.cantidad}</td>
      <td>${r.proveedor}</td>
      <td>${r.fecha_adquisicion?.toISOString ? r.fecha_adquisicion.toISOString().slice(0,10) : r.fecha_adquisicion}</td>
    </tr>`).join('');

  return `
  <!DOCTYPE html><html lang="es"><head>
    <meta charset="UTF-8" />
    <title>${title}</title>
    <link rel="stylesheet" href="/styles.css">
  </head><body>
    <h1>${title}</h1>
    <div class="actions">
      <a class="btn" href="/">Registrar</a>
      <a class="btn" href="/componentes?orden=desc">Ordenar por fecha (recientes)</a>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Cantidad</th>
            <th>Proveedor</th>
            <th>Fecha de Adquisición</th>
          </tr>
        </thead>
        <tbody>${body}</tbody>
      </table>
    </div>
  </body></html>`;
}

app.get('/componentes', (req, res) => {
  const orden = (req.query.orden || 'asc').toLowerCase() === 'desc' ? 'DESC' : 'ASC';
  const sql = `SELECT * FROM componentes ORDER BY fecha_adquisicion ${orden}, id ${orden}`;
  db.query(sql, (err, rows) => {
    if (err) {
      console.error('Error consultando datos:', err);
      return res.status(500).send(`<div class="msg err">Error al consultar componentes/sensores.</div>`);
    }
    res.send(renderTabla('Componentes y Sensores Biomédicos Registrados', rows));
  });
});
```

**Evidencia:** captura de la tabla.

---

## Ejercicio 5: Buscar Componentes/Sensores

**Ruta GET `/buscar?q=...`** (por nombre o proveedor)

```javascript
app.get('/buscar', (req, res) => {
  const q = (req.query.q || '').trim();
  if (q.length < 2) {
    return res.send(`
      <!DOCTYPE html><html lang="es"><head>
      <meta charset="UTF-8"><link rel="stylesheet" href="/styles.css"><title>Buscar</title>
      </head><body>
        <div class="msg err">Ingresa al menos 2 caracteres.</div>
        <a class="btn" href="/">Volver</a>
      </body></html>
    `);
  }
  const like = `%${q}%`;
  const sql = `
    SELECT * FROM componentes
    WHERE nombre LIKE ? OR proveedor LIKE ?
    ORDER BY fecha_adquisicion DESC, id DESC
  `;
  db.query(sql, [like, like], (err, rows) => {
    if (err) {
      console.error('Error en búsqueda:', err);
      return res.status(500).send(`<div class="msg err">Error en la búsqueda.</div>`);
    }
    res.send(renderTabla(`Resultados de búsqueda: "${q}"`, rows));
  });
});
```

**Evidencia:** dos búsquedas (una por nombre, otra por proveedor).

---

## Ejercicio 6: Ordenar por Fecha

> Usar `/componentes?orden=asc|desc`.
> **Evidencia:** capturas de ambos órdenes.

---

## Ejercicio 7: Mensajes de Confirmación

> Ya implementados en `/add-componente` (verde éxito / rojo error).
> **Evidencia:** captura de éxito y (opcional) simulación de error.

---

## Ejercicio 8: Llaves Foráneas (relación entre tablas)

### Opción A) **Proveedores** normalizados

1. **Tablas/FK**

```sql
CREATE TABLE IF NOT EXISTS proveedores (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nombre VARCHAR(120) NOT NULL UNIQUE
) ENGINE=InnoDB;

ALTER TABLE componentes
  ADD COLUMN proveedor_id INT NULL,
  ADD CONSTRAINT fk_componente_proveedor
    FOREIGN KEY (proveedor_id) REFERENCES proveedores(id)
    ON UPDATE CASCADE ON DELETE RESTRICT;
```

2. **Inserción con upsert de proveedor**

```javascript
function upsertProveedor(nombre, cb) {
  const sel = 'SELECT id FROM proveedores WHERE nombre = ?';
  db.query(sel, [nombre], (e, r) => {
    if (e) return cb(e);
    if (r.length) return cb(null, r[0].id);
    const ins = 'INSERT INTO proveedores (nombre) VALUES (?)';
    db.query(ins, [nombre], (e2, r2) => e2 ? cb(e2) : cb(null, r2.insertId));
  });
}

app.post('/add-componente', (req, res) => {
  const { nombre, cantidad, proveedor, fecha } = req.body;
  upsertProveedor(proveedor, (err, proveedorId) => {
    if (err) {
      console.error('Error con proveedor:', err);
      return res.status(500).send(`<div class="msg err">Error con proveedor.</div>`);
    }
    const sql = `
      INSERT INTO componentes (nombre, cantidad, proveedor, proveedor_id, fecha_adquisicion)
      VALUES (?, ?, ?, ?, ?)
    `;
    db.query(sql, [nombre, cantidad, proveedor, proveedorId, fecha], (e) => {
      if (e) {
        console.error('Error insertando componente:', e);
        return res.status(500).send(`<div class="msg err">Error al registrar.</div>`);
      }
      res.send(`
        <!DOCTYPE html><html lang="es"><head>
        <meta charset="UTF-8"><link rel="stylesheet" href="/styles.css"><title>Éxito</title>
        </head><body>
          <div class="msg ok">Componente/Sensor y proveedor vinculados correctamente.</div>
          <div class="actions">
            <a class="btn" href="/">Registrar otro</a>
            <a class="btn" href="/componentes">Ver componentes/sensores</a>
          </div>
        </body></html>
      `);
    });
  });
});
```

3. **Listado con JOIN (opcional)**

```javascript
app.get('/componentes-join', (req, res) => {
  const sql = `
    SELECT c.nombre, c.cantidad, p.nombre AS proveedor, c.fecha_adquisicion
    FROM componentes c
    LEFT JOIN proveedores p ON p.id = c.proveedor_id
    ORDER BY c.fecha_adquisicion DESC, c.id DESC
  `;
  db.query(sql, (err, rows) => {
    if (err) return res.status(500).send(`<div class="msg err">Error.</div>`);
    res.send(renderTabla('Componentes/Sensores (JOIN Proveedores)', rows));
  });
});
```

### Opción B) **Categorías** (p. ej., “sensor óptico”, “sensor de presión”, “electrodo”, “módulo ECG/PPG”)

* Crea `categorias(id, nombre)` y agrega `categoria_id` en `componentes` (FK).
* Añade filtro por `?categoria=...` o una vista `/componentes?categoria=...`.

**Evidencias:** creación de tablas/FK y captura de la vista con JOIN o filtro.
